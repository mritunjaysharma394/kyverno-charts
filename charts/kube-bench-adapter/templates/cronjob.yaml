apiVersion: batch/v1
kind: CronJob
metadata:
  namespace: {{ .Values.kubeBench.namespace}}
  name: {{ include "kube-bench.fullname" . }}
  labels:
    {{- include "kube-bench.labels" . | nindent 4 }}
spec:
  schedule: {{ .Values.cronjob.schedule }}
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            {{- include "kube-bench.labels" . | nindent 4 }}
        spec:
          containers:
          - name: {{ include "kube-bench.fullname" . }}
            image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
            command: ["./{{ .Values.kubeBench.command }}"]
            args: [
            "-name","{{ .Values.kubeBench.name}}",
            "-yaml", "{{ .Values.kubeBench.yaml }}",
            "-category", "{{ .Values.kubeBench.category }}",
            "-namespace", "{{ .Values.kubeBench.namespace }}",
            "-kubebenchImg", "{{ .Values.kubeBench.kubebenchImg }}",
            "-kubeconfig", "{{ .Values.kubeBench.kubeconfig }}",
            ]
            resources:
              limits:
                cpu: 100m
                memory: 200Mi
              requests:
                cpu: 100m
                memory: 200Mi
            livenessProbe:
              exec:
                command:
                - ./policyreport
              exec:
                command:
                - ./policyreport
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                - ALL
              readOnlyRootFilesystem: true
              runAsGroup: 1000
              runAsNonRoot: true
              runAsUser: 1000
          imagePullSecrets:
          - name: regcred
          restartPolicy: Never
          serviceAccountName:   {{ include "kube-bench.fullname" . }}
